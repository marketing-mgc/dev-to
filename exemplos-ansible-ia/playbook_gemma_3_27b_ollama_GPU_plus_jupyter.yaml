---
- name: Setup inference node Gemma3 (GPU + Jupyter)
  hosts: inference
  become: true
  vars:
    cuda_keyring_deb: cuda-keyring_1.1-1_all.deb
    cuda_keyring_url: "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/{{ cuda_keyring_deb }}"
    cuda_pin_url: "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin"
    cuda_pin_dest: /etc/apt/preferences.d/cuda-repository-pin-600

  tasks:
    # --- Preparação do sistema ---
    - name: Atualizar sistema e cache
      apt:
        update_cache: yes
        upgrade: dist

    - name: Instalar pacotes básicos
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - python3-full
          - git
          - curl
          - wget
          - gnupg
          - ca-certificates
          - lsb-release
          - software-properties-common
          - ufw
        state: present

    # --- Instalação do CUDA / Driver NVIDIA ---
    - name: Baixar keyring do repositório CUDA
      get_url:
        url: "{{ cuda_keyring_url }}"
        dest: "/tmp/{{ cuda_keyring_deb }}"

    - name: Instalar keyring CUDA
      apt:
        deb: "/tmp/{{ cuda_keyring_deb }}"

    - name: Adicionar prioridade para repositório CUDA
      get_url:
        url: "{{ cuda_pin_url }}"
        dest: "{{ cuda_pin_dest }}"

    - name: Atualizar cache após adicionar CUDA repo
      apt:
        update_cache: yes

    - name: Instalar CUDA Toolkit 12.9 e driver NVIDIA
      apt:
        name:
          - cuda-toolkit-12-9
          - nvidia-driver-535
        state: present

    - name: Reiniciar para ativar driver
      reboot:
        reboot_timeout: 600

    - name: Verificar driver NVIDIA
      command: nvidia-smi
      register: nvidia_output
      ignore_errors: yes

    - debug:
        var: nvidia_output.stdout

    # --- Instalar Ollama com GPU ---
    - name: Instalar Ollama
      shell: curl -fsSL https://ollama.com/install.sh | sh
      args:
        executable: /bin/bash

    - name: Criar diretório de configuração do Ollama
      file:
        path: /etc/ollama
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Configurar Ollama
      copy:
        dest: /etc/ollama/config.yaml
        content: |
          host: 0.0.0.0:8000
        owner: root
        group: root
        mode: '0644'

    - name: Recarregar e reiniciar Ollama
      systemd:
        name: ollama
        state: restarted
        enabled: true

    - name: Esperar porta 8000 disponível
      wait_for:
        host: "0.0.0.0"
        port: 8000
        timeout: 60

    # --- Instalar modelo Gemma ---
    - name: Baixar modelo Gemma3 27B
      shell: OLLAMA_HOST=http://localhost:8000 ollama run gemma3:27b
      args:
        executable: /bin/bash
      ignore_errors: yes

    # --- Instalar Jupyter via apt (sem pip/venv) ---
    - name: Instalar Jupyter Notebook e bibliotecas essenciais
      apt:
        name:
          - jupyter-notebook
          - python3-notebook
          - python3-ipykernel
          - python3-numpy
          - python3-pandas
          - python3-matplotlib
        state: present

    - name: Criar diretório de configuração do Jupyter
      file:
        path: /home/ubuntu/.jupyter
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    - name: Gerar arquivo de configuração padrão do Jupyter (sem prompt)
      shell: >
        runuser -l ubuntu -c "jupyter notebook --generate-config --allow-root --no-browser --ip=127.0.0.1 --port=8888 || true"
      args:
        creates: /home/ubuntu/.jupyter/jupyter_notebook_config.py

    - name: Configurar Jupyter para localhost
      lineinfile:
        path: /home/ubuntu/.jupyter/jupyter_notebook_config.py
        line: "c.NotebookApp.ip = '127.0.0.1'"

    - name: Definir porta padrão 8888
      lineinfile:
        path: /home/ubuntu/.jupyter/jupyter_notebook_config.py
        line: "c.NotebookApp.port = 8888"

    - name: Criar serviço systemd para Jupyter
      copy:
        dest: /etc/systemd/system/jupyter.service
        content: |
          [Unit]
          Description=Jupyter Notebook GPU
          After=network.target

          [Service]
          Type=simple
          User=ubuntu
          ExecStart=/usr/bin/jupyter-notebook --no-browser --ip=127.0.0.1 --port=8888
          WorkingDirectory=/home/ubuntu
          Restart=always

          [Install]
          WantedBy=multi-user.target

    - name: Recarregar systemd para registrar novo serviço
      command: systemctl daemon-reload

    - name: Habilitar e iniciar o serviço Jupyter
      systemd:
        name: jupyter
        state: started
        enabled: true